<html data-ng-app="gDriveApp">
<body data-ng-controller="DocsController">
<section id="main">
  <nav>
    <h2>Google Drive Uploader</h2>
    <button class="btn" data-ng-click="fetchDocs()">Refresh</button>
    <button class="btn" id="close-button" title="Close"></button>
  </nav>
  <ul>
    <li data-ng-repeat="doc in docs">
      <img data-ng-src="{{doc.icon}}"> <a href="{{doc.alternateLink}}">{{doc.title}}</a>  {{doc.size}}
      <span class="date">{{doc.updatedDate}}</span>
    </li>
  </ul>
</section>
<script type="text/javascript">
	GDocs.prototype.auth = function(opt_callback) {
		  try {
		    chrome.identity.getAuthToken({interactive: false}, function(token) {
		      if (token) {
		        this.accessToken = token;
		        opt_callback && opt_callback();
		      }
		    }.bind(this));
		  } catch(e) {
		    console.log(e);
		  }
		};

	var gDriveApp = angular.module('gDriveApp', []);

	gDriveApp.factory('gdocs', function() {
	  var gdocs = new GDocs();
	  return gdocs;
	});

	function DocsController($scope, $http, gdocs) {
	  $scope.docs = [];

	  $scope.fetchDocs = function() {
	     ...
	  };

	  // Invoke on ctor call. Fetch docs after we have the oauth token.
	  gdocs.auth(function() {
	    $scope.fetchDocs();
	  });

	}
	$scope.fetchDocs = function() {
	  $scope.docs = []; // First, clear out any old results

	  // Response handler that doesn't cache file icons.
	  var successCallback = function(resp, status, headers, config) {
	    var docs = [];
	    var totalEntries = resp.feed.entry.length;

	    resp.feed.entry.forEach(function(entry, i) {
	      var doc = {
	        title: entry.title.$t,
	        updatedDate: Util.formatDate(entry.updated.$t),
	        updatedDateFull: entry.updated.$t,
	        icon: gdocs.getLink(entry.link,
	                            'http://schemas.google.com/docs/2007#icon').href,
	        alternateLink: gdocs.getLink(entry.link, 'alternate').href,
	        size: entry.docs$size ? '( ' + entry.docs$size.$t + ' bytes)' : null
	      };

	      $scope.docs.push(doc);

	      // Only sort when last entry is seen.
	      if (totalEntries - 1 == i) {
	        $scope.docs.sort(Util.sortByDate);
	      }
	    });
	  };

	  var config = {
	    params: {'alt': 'json'},
	    headers: {
	      'Authorization': 'Bearer ' + gdocs.accessToken,
	      'GData-Version': '3.0'
	    }
	  };

	  $http.get(gdocs.DOCLIST_FEED, config).success(successCallback);
	};
</script>


</body>
</html>